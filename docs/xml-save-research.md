# X4 XML Save Research: What This Editor Can Read and Edit

This document summarizes the practical XML structure assumptions in this repository and maps them to **what can actually be edited** by the current patch engine.

---

## 1) Save file format handling

The editor supports:

- `.xml` (plain XML)
- `.xml.gz` / `.gz` (gzip-compressed XML)

Compression detection is done by extension first, then by checking gzip magic bytes `1f 8b` in the file header. This means renamed gzip saves without `.gz` still import correctly. On export, gzip uses `Z_BEST_SPEED`.  

**Implication:** format/compression is editable (you can export either compressed or uncompressed), while XML content edits are independent of compression.

---

## 2) Indexed XML entities (what the importer scans)

The indexer is SAX-based and reads the save as a stream. It extracts these entity families:

1. **Accounts** from `<account ...>`
   - Reads: `id`, `owner`, `money` (or `credits` fallback), `type`
2. **Relations** from `<relation ...>` where `source`, `target`, or `owner` is `player`
   - Reads: `faction`/`target`/`source` as faction id, `value`
3. **NPCs / Crew** from `<npc>`, `<person>`, `<crew>`
   - Reads: `id`, `name`, `role`, `owner`, assignment fields
   - Nested `<skill ...>` attributes become skill map entries
4. **Blueprints** from `<blueprint ...>`
   - Reads: `id`, boolean unlocked from `unlocked` or `owned`, `category`
5. **Inventory** from `<item ...>` where `container="inventory"` or `owner="player"`
   - Reads: `id`, `amount`
6. **Objects** from `<object>`, `<component>`, `<ship>`, `<station>`
   - Reads: id from `id`/`component`/`code`, plus `owner`, `class`, `sector`

**Implication:** only these XML areas are surfaced in the UI model, and patch generation is designed around them.

---

## 3) Patch types supported by the app (source of truth)

The UI generates these patch types, and the patch engine normalizes them:

- `SetCredits` with scope `player` or `allOwnedAccounts`
- `SetFactionRep`
- `SetSkills`
- `UnlockBlueprints`
- `SetInventoryItem`
- `AddInventoryItem` (normalized, but not currently generated by UI)
- `RemoveInventoryItem` (normalized, but not currently generated by UI)
- `ChangeOwner`
- `DeleteObject`

Conflict resolution is deterministic by "last write wins" in maps/sets during normalization.

---

## 4) Exact XML attributes this editor mutates during export

The rewriter makes **attribute-level** edits only; it does not rebuild or reorder structure intentionally.

### 4.1 Credits / money
- Target tag: `<account>`
- Mutated attribute: `money`
- Rules:
  - If `owner="player"` and there is `SetCredits(scope="player")`, set `money`
  - If `owner!="player"` and there is `SetCredits(scope="allOwnedAccounts")`, set `money`
- Validation: value must be `>= 0`

### 4.2 Faction reputation
- Target tag: `<relation>`
- Mutated attribute: `value`
- Match key: `faction` or fallback to `target`/`source`
- Validation: rep must be in `[-30, 30]`

### 4.3 Skills
- Target tag: `<skill>`
- Mutated attribute: `value`
- Match key: `type` (lowercased)
- Important behavior: `SetSkills.filter` is currently ignored in rewrite logic; any matching skill type is changed globally.

### 4.4 Blueprints
- Target tag: `<blueprint>`
- Mutated attributes when matched by `id`:
  - `unlocked="1"`
  - `owned="1"`

### 4.5 Inventory items
- Target tag: `<item>`
- Mutated attribute: `amount`
- Match key: item `id`
- `RemoveInventoryItem` becomes `amount=0` (does not physically remove tag)

### 4.6 Object ownership
- Target tags: `<object>`, `<component>`, `<ship>`, `<station>`
- Mutated attribute: `owner`
- Match key: object id from `id`/`component`/`code`

### 4.7 Object deletion
- Target tags: `<object>`, `<component>`, `<ship>`, `<station>`
- Behavior: matching node is skipped entirely with subtree-depth skipping (hard delete in output XML)

---

## 5) What is *not* currently editable (even if visible in XML)

Based on parser/rewriter logic, these are out of scope right now:

- Mission state, plot flags, quest logic
- Position/transform values for objects
- Production chains, station module internals (beyond blueprint unlock)
- Economy simulation internals beyond account money and relation values
- Direct creation of new XML elements (except changing existing attributes / deleting nodes)
- Selective skill edits by crew role filter during rewrite (filter is captured in patch data but not enforced)

---

## 6) Safety and export behavior

- Optional backup writes to `<source>.backup<ext>` before export.
- Writes to `<output>.tmp` first, then renames for safer export completion.
- XML escaping is applied for attributes and text.
- Deletions are structural and can remove complete object subtrees.

---

## 7) Practical "editable field matrix"

| Domain | XML tag(s) | Match key | Edited attribute(s) | Notes |
|---|---|---|---|---|
| Credits | `account` | `owner` | `money` | `player` or non-player scopes |
| Relations | `relation` | `faction`/`target`/`source` | `value` | validated `-30..30` |
| Skills | `skill` | `type` | `value` | role filter currently not enforced in writer |
| Blueprints | `blueprint` | `id` | `unlocked`, `owned` | set to `1` |
| Inventory | `item` | `id` | `amount` | remove = set to `0` |
| Objects (owner) | `object/component/ship/station` | `id/component/code` | `owner` | faction id string |
| Objects (delete) | `object/component/ship/station` | `id/component/code` | entire node | subtree skipped |

---

## 8) Repository data useful for edit targeting

Bundled dictionaries exist for UI/lookup support:

- `data/blueprints.json` (1300 entries; categories include ship/equipment/station)
- `data/items.json` (300 entries)
- `data/factions.json` (5 entries)

These datasets help choose valid IDs for patch payloads, though the rewriter itself applies IDs as provided.

---

## 9) Recommended next improvements (if we want broader XML edit coverage)

1. Enforce `SetSkills.filter` during rewrite by tracking current NPC context and role.
2. Add targeted patch types for mission/plot flags (carefully schema-tested).
3. Add schema guards or optional "strict mode" for invalid id/value combos.
4. Support optional hard remove for inventory items (delete nodes), not just amount `0`.
5. Add dry-run validation report: list matched vs unmatched patch targets before export.


## Verified NPC skills schemas (streaming-safe)

Supported and tested NPC structures:

- `<component class="npc" id="[0x...]" name="...">` with `<traits><skills morale=".." piloting=".." management=".." engineering=".." boarding=".."/></traits>`.
- `<component class="npc" id="[0x...]" ...>` with `<traits><skill type="management" value="5"/></traits>` style nodes.
- Ship/station crew links from `<control><post id="aipilot|engineer|manager" component="[0xNPC]"/></control>` where `component` joins directly to NPC component `id`.

Guardrails:
- Only proven NPC component schemas are editable.
- If NPC has no `<traits>` block, no traits are invented.
- `<people><person>` editing is intentionally not supported due to weak/non-stable linking evidence.
